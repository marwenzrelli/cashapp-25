// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://jyqtmpbdicwofkhtvjyy.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5cXRtcGJkaWN3b2ZraHR2anl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEyODYxNDQsImV4cCI6MjA1Njg2MjE0NH0.SgNQ6W-XSiVPt9GsyurqtF2VOuraUjr4QklC6tF8QKw";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
  },
  global: {
    // Add headers that include the API key
    headers: {
      'apikey': SUPABASE_PUBLISHABLE_KEY,
      // Add Cache-Control header to reduce caching issues
      'Cache-Control': 'no-cache'
    },
    // Enhanced fetch with improved timeout and abort handling
    fetch: (url, options) => {
      // Create abort controller with longer timeout (45 seconds)
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort('Timeout exceeded'), 45000);
      
      // Add retry capability for network errors
      const attemptFetch = async (retries = 2) => {
        try {
          // Use the controller's signal
          const response = await fetch(url, {
            ...options,
            signal: controller.signal,
            // Ensure we don't cache responses that might be stale
            cache: 'no-store',
            // Set keep-alive for better connection reuse
            keepalive: true
          });
          
          // Clear the timeout if successful
          clearTimeout(timeoutId);
          return response;
        } catch (error: any) {
          // Only retry on network errors, not on aborts or other issues
          if (retries > 0 && (error.name === 'TypeError' || error.message?.includes('network'))) {
            console.log(`Retrying fetch due to network error (${retries} retries left)`);
            // Exponential backoff: wait longer with each retry
            await new Promise(r => setTimeout(r, (3 - retries) * 1000));
            return attemptFetch(retries - 1);
          }
          
          // Clear the timeout and re-throw
          clearTimeout(timeoutId);
          throw error;
        }
      };
      
      return attemptFetch();
    }
  },
  // Set database timeouts
  db: {
    schema: 'public',
  },
  // Adjust realtime timeout and auto-reconnection
  realtime: {
    timeout: 45000, // 45 seconds timeout
    params: {
      eventsPerSecond: 10
    }
  }
});

// Function to test Supabase connection
export const testSupabaseConnection = async (): Promise<boolean> => {
  try {
    // Create a more controlled test with timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort('Connection test timeout'), 10000);
    
    try {
      // Simple query to test connection
      const { error } = await supabase.from('profiles').select('id').limit(1).abortSignal(controller.signal);
      clearTimeout(timeoutId);
      return !error;
    } catch (error) {
      clearTimeout(timeoutId);
      console.error("Error testing Supabase connection:", error);
      return false;
    }
  } catch (error) {
    console.error("Error in testSupabaseConnection:", error);
    return false;
  }
};

// Utility function to check network connection and Supabase availability
export const checkSupabaseAvailability = async (): Promise<{
  online: boolean;
  serverAvailable: boolean;
  errorMessage?: string;
}> => {
  // First check if browser is online
  const online = typeof navigator !== 'undefined' && navigator.onLine !== false;
  
  if (!online) {
    return { online: false, serverAvailable: false, errorMessage: "Vous êtes hors ligne. Veuillez vérifier votre connexion internet." };
  }
  
  // Then try to reach Supabase
  try {
    const isAvailable = await testSupabaseConnection();
    return { 
      online: true, 
      serverAvailable: isAvailable,
      errorMessage: isAvailable ? undefined : "Le serveur semble temporairement inaccessible."
    };
  } catch (error: any) {
    return { 
      online: true, 
      serverAvailable: false, 
      errorMessage: error.message || "Erreur de connexion au serveur." 
    };
  }
};
